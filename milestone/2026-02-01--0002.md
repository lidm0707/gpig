# User(-7) Diff Processing Error

## Date
2026-02-01

## Error Description

A mysterious error appears when processing diffs for certain files:
```
Error processing diff for file crates/gpui/docs/overview.md: no error; code=User (-7)
```

### Error Characteristics

- **Error Code**: User(-7) - User-space error code
- **Message**: "no error" (contradictory)
- **Status**: Non-fatal, operation continues
- **Occurrence**: During diff computation for individual files

### Affected Files

Files triggering this error include:
- `crates/settings_content/src/editor.rs`
- `crates/encoding_selector/src/encoding_selector.rs`
- `crates/zed/src/zed.rs`
- `crates/gpui/docs/overview.md`

### Context

This error appears in two scenarios:
1. **New files (Added status)**: Files newly created in commits
2. **Modified files**: Files with changes in commits

Notable observation: Some files show both successful diff processing AND the error:
```
Adding changed file: crates/zed/src/zed.rs (status: Modified)
Successfully processed diff, found 13 changed files
Error processing diff for file crates/zed/src/zed.rs: no error; code=User (-7)
```

## Root Cause Analysis

### What User(-7) Means

The `User(-7)` error code indicates:
- **User-space error**: Not a system error or standard library error
- **External tool origin**: Likely from IDE, git tool, or diff viewer
- **Non-standard**: Not part of git2 library's error codes (git2 uses codes -3 to -31)

### Potential Sources

1. **Zed Editor**: The error files are from Zed's `crates/` directory
2. **Git diff tools**: External diff viewers or formatters
3. **Build/test systems**: Cargo or other build tools
4. **IDE features**: Linters, formatters, or syntax checkers
5. **Language servers**: Rust analyzer or other LSPs

### Why "No Error"?

The "no error" message suggests:
- The error code is set but no actual error occurred
- A signal from a tool that completed successfully
- A non-critical status being reported as an error
- Race condition or timing issue in tool chain

## What We've Done

### 1. Added Binary File Detection

Implemented in `src/garph.rs`:
- `is_binary_file()` function to detect binary files
- Checks for null bytes in first 8000 bytes (git's heuristic)
- Limits files to 10 MB maximum size
- Prevents attempting to diff binary files like `.wasm`

### 2. Added File Size Limits

- `MAX_FILE_SIZE_BYTES: usize = 10 * 1024 * 1024`
- Prevents memory exhaustion from large files
- Early return with informative message for oversized files

### 3. Added File Detection in Diff

- Added `file_found` flag to track if target file exists in diff
- Returns informative message when file not found:
  - File path has changed
  - File was renamed
  - File is in a subdirectory

### 4. Enhanced Error Handling

```rust
fn is_binary_file(repo: &git2::Repository, commit: &git2::Commit, file_path: &str) -> bool
fn get_file_size(repo: &git2::Repository, commit: &git2::Commit, file_path: &str) -> Option<usize>
```

### 5. Improved Changed Files Display

In `src/workspace.rs`:
- Added `overflow_y_scroll()` to file list container
- Added `overflow_hidden()` and `whitespace_nowrap()` to file paths
- Added `max_w(px(400.0))` to constrain file path width
- Prevents UI overflow from long file names

## Investigation Status

### Confirmed

✅ Error is not from gpig Rust code  
✅ Error occurs for both Added and Modified files  
✅ Error is non-fatal, operation continues  
✅ Affected files are from Zed project (`crates/` directory)  
✅ Binary file detection and size limits working correctly  

### Unresolved

❓ Exact source of User(-7) error  
❓ Why "no error" message appears with error code  
❓ Specific trigger conditions  
❓ Why some files show both success and error  
❓ Whether error can be prevented or needs to be ignored  

## Recommendations

### Immediate Actions

1. **Ignore error for now**: The error is non-fatal and operations complete successfully
2. **Monitor logs**: Continue watching for patterns in when error occurs
3. **Check IDE settings**: Review Zed Editor configuration for diff/file handling
4. **Git configuration**: Check git hooks or diff tools that might be triggered

### Future Investigations

1. **Trace error source**: Add logging to identify which tool/process generates User(-7)
2. **Test isolation**: Try processing diffs outside Zed to isolate the issue
3. **Disable plugins**: Temporarily disable IDE plugins to see if any are responsible
4. **Check tool versions**: Verify git, cargo, and other tool versions
5. **Reproduce in clean environment**: Test in minimal setup to eliminate interference

### Code Improvements

1. **Add error filtering**: Consider filtering User(-7) errors if confirmed harmless
2. **Enhanced logging**: Add more context when errors occur
3. **Error categorization**: Distinguish between fatal and non-fatal errors
4. **User feedback**: Show non-fatal errors as warnings instead of errors

## Related Issues

- Memory exhaustion bug (2026-02-01--0001.md) - Fixed
- Changed files overflow issue - Fixed
- Graph node sizing with long text - Fixed

## Notes

- This error does NOT prevent the application from functioning
- Diff operations complete successfully despite the error
- The error appears to be informational/warning in nature
- Focus should remain on user-facing bugs rather than this non-critical issue